# =============================================================================
# Secure Build Workflow - Isolamento de Runtime com gVisor
# =============================================================================
# O perigo do docker.sock:
# Montar o socket do Docker dentro do runner concede ao job controle total 
# sobre o daemon host. Um cont√™iner malicioso pode executar docker exec contra 
# outros containers ou iniciar processos privilegiados ‚Äì cl√°ssico container escape.
#
# Como o gVisor corta o caminho:
# gVisor (runsc) substitui o kernel Linux por um user-space kernel que intercepta 
# todas as syscalls. Cada chamada √© analisada e, se n√£o estiver na whitelist, √© 
# bloqueada. O cont√™iner nunca atinge o kernel real, reduzindo drasticamente a 
# superf√≠cie de ataque.
#
# ‚ö†Ô∏è AVISO: Este workflow requer um self-hosted runner configurado com gVisor
# =============================================================================

name: Secure Build

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: hardened-sh/secure-pipeline-poc

jobs:
  secure-build:
    name: Build Hardenado com gVisor
    runs-on: self-hosted  # Runner com gVisor configurado
    
    # Container executado com runtime isolado
    container:
      image: ubuntu:22.04
      options: >-
        --runtime=runsc
        --security-opt=no-new-privileges:true
        --cap-drop=ALL
        --cap-add=NET_BIND_SERVICE
        --read-only
        --tmpfs /tmp:rw,noexec,nosuid
    
    permissions:
      contents: read
      packages: write
      id-token: write
    
    steps:
      - name: Checkout c√≥digo (modo seguro)
        uses: actions/checkout@v4
        with:
          persist-credentials: false
      
      - name: Verificar isolamento gVisor
        run: |
          echo "üîí Verificando ambiente de execu√ß√£o..."
          
          # Verificar se estamos em gVisor
          if dmesg 2>/dev/null | grep -q "gVisor"; then
            echo "‚úÖ Executando dentro do gVisor sandbox"
          else
            echo "‚ö†Ô∏è gVisor pode n√£o estar ativo - verifique a configura√ß√£o do runner"
          fi
          
          # Verificar usu√°rio
          echo "üë§ Usu√°rio atual: $(whoami)"
          echo "üÜî UID: $(id -u), GID: $(id -g)"
          
          # Verificar capabilities
          echo "üîê Capabilities:"
          cat /proc/self/status | grep Cap || echo "Sem acesso a capabilities"
      
      - name: Execu√ß√£o limitada como usu√°rio n√£o-root
        run: |
          # Criar usu√°rio n√£o privilegiado se n√£o existir
          if ! id -u runner &>/dev/null; then
            useradd -m -s /bin/bash runner || true
          fi
          
          echo "üî® Iniciando build em ambiente isolado..."
          
          # Executar comandos de build como usu√°rio limitado
          sudo -u runner bash -c '
            echo "Compilando dentro de gVisor sandbox..."
            echo "PWD: $(pwd)"
            echo "USER: $(whoami)"
            
            # Simular comandos de build
            echo "‚úÖ Ambiente de build validado"
          ' || echo "Usando usu√°rio atual"
      
      - name: Teste de isolamento - Syscalls bloqueadas
        run: |
          echo "üß™ Testando bloqueio de syscalls perigosas..."
          
          # Tentar opera√ß√µes que devem ser bloqueadas pelo gVisor
          set +e
          
          # Tentativa de montar filesystem (deve falhar)
          mount -t tmpfs none /mnt 2>&1 && echo "‚ùå FALHA: mount n√£o bloqueado" || echo "‚úÖ mount bloqueado"
          
          # Tentativa de acessar dispositivos raw (deve falhar)
          cat /dev/mem 2>&1 && echo "‚ùå FALHA: /dev/mem acess√≠vel" || echo "‚úÖ /dev/mem inacess√≠vel"
          
          # Tentativa de modificar m√≥dulos do kernel (deve falhar)
          modprobe dummy 2>&1 && echo "‚ùå FALHA: modprobe n√£o bloqueado" || echo "‚úÖ modprobe bloqueado"
          
          set -e
          echo "‚úÖ Testes de isolamento conclu√≠dos"
      
      - name: Build da aplica√ß√£o
        run: |
          echo "üì¶ Executando build da aplica√ß√£o..."
          
          # Comandos de build seguros aqui
          # Exemplo: make build, npm install, etc.
          
          echo "‚úÖ Build conclu√≠do com sucesso"

  # ==========================================================================
  # Fallback para runners sem gVisor (GitHub-hosted)
  # ==========================================================================
  secure-build-fallback:
    name: Build com Restri√ß√µes (Fallback)
    runs-on: ubuntu-latest
    if: ${{ failure() || github.event_name == 'workflow_dispatch' }}
    
    permissions:
      contents: read
      packages: write
      id-token: write
    
    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4
      
      - name: Build com restri√ß√µes de seguran√ßa
        run: |
          echo "‚ö†Ô∏è Executando em runner GitHub-hosted (sem gVisor)"
          echo "üîí Aplicando restri√ß√µes alternativas..."
          
          # Usar container com restri√ß√µes
          docker run --rm \
            --security-opt=no-new-privileges:true \
            --cap-drop=ALL \
            --read-only \
            --tmpfs /tmp:rw,noexec,nosuid \
            --network=none \
            -v "$(pwd):/workspace:ro" \
            -w /workspace \
            alpine:3.19 \
            sh -c '
              echo "üî® Build em container restrito..."
              echo "‚úÖ Build conclu√≠do"
            '

  # ==========================================================================
  # An√°lise de seguran√ßa do runtime
  # ==========================================================================
  runtime-audit:
    name: Auditoria de Runtime
    runs-on: ubuntu-latest
    needs: [secure-build-fallback]
    if: always()
    
    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4
      
      - name: Verificar configura√ß√µes de seguran√ßa
        run: |
          echo "üîç Auditoria de configura√ß√µes de runtime..."
          
          # Verificar se docker.sock est√° exposto
          if [ -S /var/run/docker.sock ]; then
            echo "‚ö†Ô∏è AVISO: docker.sock est√° acess√≠vel"
            echo "Recomenda√ß√£o: Configure runners self-hosted com gVisor"
          else
            echo "‚úÖ docker.sock n√£o est√° exposto neste contexto"
          fi
          
          # Verificar permiss√µes do processo
          echo ""
          echo "üìä Informa√ß√µes do processo:"
          echo "User: $(whoami)"
          echo "Groups: $(groups)"
          
          echo ""
          echo "‚úÖ Auditoria conclu√≠da"
